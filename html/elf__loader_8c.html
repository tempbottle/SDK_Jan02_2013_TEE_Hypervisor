<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>elf_loader.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_6aeebb853ebd8c514e6186653c592c82.html">otzone</a></li><li class="navelem"><a class="el" href="dir_fb44076c8b62c63869cf8a830933e50d.html">src</a></li><li class="navelem"><a class="el" href="dir_5054d892aa124e015c653e8232659643.html">arch</a></li><li class="navelem"><a class="el" href="dir_a8ff73de53c273984b8a08f3bd00cae5.html">arm</a></li><li class="navelem"><a class="el" href="dir_0f6da8a9c5259cd162214505231682b4.html">armv7</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">elf_loader.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="elf_8h_source.html">elf.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="task_8h_source.html">task.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="secure__api_8h_source.html">secure_api.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__debug_8h_source.html">sw_debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="otz__id_8h_source.html">otz_id.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="fat32_8h_source.html">fat32.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="page__table_8h_source.html">page_table.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="dispatcher__task_8h_source.html">dispatcher_task.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__string__functions_8h_source.html">sw_string_functions.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__mem__functions_8h_source.html">sw_mem_functions.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="mem__mng_8h_source.html">mem_mng.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__list_8h_source.html">sw_list.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="cpu__data_8h_source.html">cpu_data.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__types_8h_source.html">sw_types.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="elf__loader__app_8h_source.html">elf_loader_app.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="elf__loader_8h_source.html">elf_loader.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sw__board_8h_source.html">sw_board.h</a>&gt;</code><br/>
</div>
<p><a href="elf__loader_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ad0cb393dc26e87df4d12de04f9889b2d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="elf__loader_8c.html#ad0cb393dc26e87df4d12de04f9889b2d">__KSYMTAB_ADDR</a>&#160;&#160;&#160;((<a class="el" href="sw__types_8h.html#a8a8f44dda695920b3f7210c1c28ff23b">va_t</a> *)&amp;<a class="el" href="cpu__data_8h.html#a01574a4c757686b05cf653e478de2457">_SW_KSYMTAB</a>)</td></tr>
<tr class="separator:ad0cb393dc26e87df4d12de04f9889b2d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab6814f634bead0f3ecd360e88acd9df8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="elf__loader_8c.html#ab6814f634bead0f3ecd360e88acd9df8">elf_loader_cleanup</a> (void)</td></tr>
<tr class="memdesc:ab6814f634bead0f3ecd360e88acd9df8"><td class="mdescLeft">&#160;</td><td class="mdescRight">clean up function to remove the mappings  <a href="#ab6814f634bead0f3ecd360e88acd9df8"></a><br/></td></tr>
<tr class="separator:ab6814f634bead0f3ecd360e88acd9df8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acbdca6c083b942acbb03820f4892bf15"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="elf__loader_8c.html#acbdca6c083b942acbb03820f4892bf15">get_number_of_loadable_segments</a> (int fp, <a class="el" href="structElf32__Ehdr.html">Elf32_Ehdr</a> *elf_header, <a class="el" href="structElf32__Phdr.html">Elf32_Phdr</a> **phdr_tab)</td></tr>
<tr class="memdesc:acbdca6c083b942acbb03820f4892bf15"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets the number of loadable segments, ie segments with type PT_LOAD.  <a href="#acbdca6c083b942acbb03820f4892bf15"></a><br/></td></tr>
<tr class="separator:acbdca6c083b942acbb03820f4892bf15"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa6f94b3aa31ace269a815e3faf5f3a63"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="elf__loader_8c.html#aa6f94b3aa31ace269a815e3faf5f3a63">elf_load</a> (struct <a class="el" href="structsa__config__t.html">sa_config_t</a> *conf)</td></tr>
<tr class="memdesc:aa6f94b3aa31ace269a815e3faf5f3a63"><td class="mdescLeft">&#160;</td><td class="mdescRight">the main elf loader function  <a href="#aa6f94b3aa31ace269a815e3faf5f3a63"></a><br/></td></tr>
<tr class="separator:aa6f94b3aa31ace269a815e3faf5f3a63"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ad0cb393dc26e87df4d12de04f9889b2d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __KSYMTAB_ADDR&#160;&#160;&#160;((<a class="el" href="sw__types_8h.html#a8a8f44dda695920b3f7210c1c28ff23b">va_t</a> *)&amp;<a class="el" href="cpu__data_8h.html#a01574a4c757686b05cf653e478de2457">_SW_KSYMTAB</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="elf__loader_8c_source.html#l00048">48</a> of file <a class="el" href="elf__loader_8c_source.html">elf_loader.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="aa6f94b3aa31ace269a815e3faf5f3a63"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int elf_load </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structsa__config__t.html">sa_config_t</a> *&#160;</td>
          <td class="paramname"><em>conf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>the main elf loader function </p>
<p>The main loader function which will be called by the <a class="el" href="sw__syscall_8h.html#ac0f29297004391a1e1557007fb5f8d7a" title="system call to load a elf">__elf_load()</a> syscall, has functionality for handling both relocatable files and executable files, although executable file support is not required as of now, so control doesn't go to the executable file part of the function.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">conf</td><td>: configuration parameter for the task</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 on failure </dd></dl>

<p>Definition at line <a class="el" href="elf__loader_8c_source.html#l00678">678</a> of file <a class="el" href="elf__loader_8c_source.html">elf_loader.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <a class="code" href="structElf32__Ehdr.html">Elf32_Ehdr</a> elf_header;</div>
<div class="line">        <a class="code" href="structElf32__Ehdr.html">Elf32_Ehdr</a> *tmp_ehdr;</div>
<div class="line">        <a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> rel = 0;</div>
<div class="line">        <a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> num_bytes = 0,va_offset,status;</div>
<div class="line">        <span class="keywordtype">int</span> num_of_segments,fp = -1,ret = <a class="code" href="sw__semaphores_8h.html#aad472a601abac5aab18d6afddeab7de5">OTZ_OK</a>,mode = <a class="code" href="fat32_8h.html#ad52d51659a75e25d96fb04d22ff718cb">FILE_READ</a>;</div>
<div class="line">        <a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> *flag = <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,*base_va = <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line">        <a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> offset,leftover_size, num_of_loadable_segments = 0;</div>
<div class="line">        <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *phdr_table = <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *tmp_phdr = <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line">        <span class="keywordtype">char</span> *leftover_data = <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"></div>
<div class="line">        conf-&gt;<a class="code" href="structsa__config__t.html#aaf22a3f2509c5b4b1c7eeccc4be71a10">elf_flag</a> = -1;</div>
<div class="line">        ret = init_map_loader(conf);</div>
<div class="line">        <span class="keywordflow">if</span>(ret != 0)</div>
<div class="line">        {</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;Mapping PA to VA failed\n&quot;</span>);</div>
<div class="line">                ret = -1;</div>
<div class="line">                <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line">        fp = <a class="code" href="fat32_8c.html#a84769e634b08f5a3d70176e0bec32979" title="Function to open a specific file mentioned in the path based on the incoming modes.">file_open</a>(conf-&gt;<a class="code" href="structsa__config__t.html#a6c77834580e13c7c41f8325317aca810">file_path</a>,mode);</div>
<div class="line">        <span class="keywordflow">if</span>(fp == -1){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;unable to open file\n&quot;</span>);</div>
<div class="line">                ret =- 1;</div>
<div class="line">                <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        rel = validate_elf_header(fp,&amp;elf_header);</div>
<div class="line">        tmp_ehdr = &amp;elf_header;</div>
<div class="line">        <span class="keywordflow">if</span>(rel == 1){</div>
<div class="line">                status = relocate_elf_loader(fp,tmp_ehdr,conf);</div>
<div class="line"><span class="comment">/* We dont care about whatever be the status here, because we need to clean up </span></div>
<div class="line"><span class="comment">* the elf_loader task irrespective of the result */</span></div>
<div class="line">                ret = status;</div>
<div class="line">                <span class="keywordflow">if</span>(status == -1 ||  status == 0)</div>
<div class="line"></div>
<div class="line">                        <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(rel == -1 ){</div>
<div class="line">                ret = -1;</div>
<div class="line">                <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Here we are dealing with a executable...right now the executable</span></div>
<div class="line"><span class="comment">         * support is not required.. */</span></div>
<div class="line">        <span class="keywordflow">goto</span> out;</div>
<div class="line">        conf-&gt;<a class="code" href="structsa__config__t.html#a9b45e143ad53f31f96d95d6445a85a96">entry_point</a> = elf_header.<a class="code" href="structElf32__Ehdr.html#ab8a982696048d807017919b7d0145482">e_entry</a>;</div>
<div class="line"></div>
<div class="line">        num_of_loadable_segments = <a class="code" href="elf__loader_8c.html#acbdca6c083b942acbb03820f4892bf15" title="Gets the number of loadable segments, ie segments with type PT_LOAD.">get_number_of_loadable_segments</a>(fp,</div>
<div class="line">                        &amp;elf_header,&amp;phdr_table);</div>
<div class="line">        <span class="keywordflow">if</span>(num_of_loadable_segments == -1){</div>
<div class="line">                ret =- 1;</div>
<div class="line">                <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line">        tmp_phdr = phdr_table;</div>
<div class="line"><span class="comment">/* array of u32 entries whose total number equals number_of_loadable_segments */</span></div>
<div class="line">        flag = <a class="code" href="sw__buddy_8h.html#a66652368e6d05f18bdc4be02b0c62694">sw_malloc</a>(num_of_loadable_segments * <span class="keyword">sizeof</span>(<a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>) );</div>
<div class="line">        <span class="keywordflow">if</span>(flag  == <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;No memory available\n&quot;</span>);</div>
<div class="line">                ret =- 1;</div>
<div class="line">                <span class="keywordflow">goto</span> out;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="sw__mem__functions_8h.html#a14af1b39b1154a36624740bad34b813f" title="memory set">sw_memset</a>(flag,0x0,num_of_loadable_segments * <span class="keyword">sizeof</span>(<a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>));</div>
<div class="line">        <span class="keywordflow">for</span>(num_of_segments = 0;num_of_segments &lt; elf_header.<a class="code" href="structElf32__Ehdr.html#a360898812db1655f8cb8258780d9df5b">e_phnum</a>;</div>
<div class="line">                        num_of_segments++){</div>
<div class="line">                <span class="keywordflow">if</span>(tmp_phdr-&gt;p_type == <a class="code" href="elf_8h.html#a84d7768fd6c6ece599d297090900cf92">PT_LOAD</a>)</div>
<div class="line">                {</div>
<div class="line"><span class="comment">/* we need to check if the segment contains the .bss section </span></div>
<div class="line"><span class="comment"> *  in which p_filesz &lt; p_memsz */</span></div>
<div class="line">                        <span class="keywordflow">if</span>(tmp_phdr-&gt;p_filesz == tmp_phdr-&gt;p_memsz)</div>
<div class="line">                        {</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                                va_offset = tmp_phdr-&gt;p_vaddr;  </div>
<div class="line"></div>
<div class="line">                                offset = tmp_phdr-&gt;p_offset;                    </div>
<div class="line">                                <a class="code" href="fat32_8c.html#aca830bf635040373e76a89987ab6658e" title="Function to seek the opened file pointer to the desired location so that subsequent read and write op...">file_seek</a>(fp,0,<a class="code" href="fat32_8h.html#ae2c4c68b8f9b63358f8c8f32b77ecb09">FILE_SEEK_SET</a>); </div>
<div class="line">                                <a class="code" href="fat32_8c.html#aca830bf635040373e76a89987ab6658e" title="Function to seek the opened file pointer to the desired location so that subsequent read and write op...">file_seek</a>(fp,offset,<a class="code" href="fat32_8h.html#ae2c4c68b8f9b63358f8c8f32b77ecb09">FILE_SEEK_SET</a>);</div>
<div class="line">                                num_bytes = 0;</div>
<div class="line">                                num_bytes = <a class="code" href="fat32_8c.html#a273aa89ce2f3dc57b21dfbbe3c64267b" title="Function to read the contents of a file.">file_read</a>(fp,((<span class="keywordtype">char</span> *)base_va</div>
<div class="line">                                                        + va_offset ),</div>
<div class="line">                                                tmp_phdr-&gt;p_filesz);    </div>
<div class="line">                                <span class="keywordflow">if</span>(num_bytes != tmp_phdr-&gt;p_filesz){</div>
<div class="line">                                        <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;Reading segment failed\n&quot;</span>);</div>
<div class="line">                                        ret = -1;</div>
<div class="line">                                        <span class="keywordflow">goto</span> out;</div>
<div class="line">                                }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp_phdr-&gt;p_filesz &lt; tmp_phdr-&gt;p_memsz){</div>
<div class="line"></div>
<div class="line">                                va_offset = tmp_phdr-&gt;p_vaddr;</div>
<div class="line">                                offset = tmp_phdr-&gt;p_offset; </div>
<div class="line">                                <a class="code" href="fat32_8c.html#aca830bf635040373e76a89987ab6658e" title="Function to seek the opened file pointer to the desired location so that subsequent read and write op...">file_seek</a>(fp,0,<a class="code" href="fat32_8h.html#ae2c4c68b8f9b63358f8c8f32b77ecb09">FILE_SEEK_SET</a>); </div>
<div class="line">                                <a class="code" href="fat32_8c.html#aca830bf635040373e76a89987ab6658e" title="Function to seek the opened file pointer to the desired location so that subsequent read and write op...">file_seek</a>(fp,offset,<a class="code" href="fat32_8h.html#ae2c4c68b8f9b63358f8c8f32b77ecb09">FILE_SEEK_SET</a>);</div>
<div class="line">                                num_bytes = 0;</div>
<div class="line">                                num_bytes = <a class="code" href="fat32_8c.html#a273aa89ce2f3dc57b21dfbbe3c64267b" title="Function to read the contents of a file.">file_read</a>(fp,((<span class="keywordtype">char</span> *)base_va +</div>
<div class="line">                                                        va_offset),</div>
<div class="line">                                                tmp_phdr-&gt;p_filesz);            </div>
<div class="line">                                <span class="keywordflow">if</span>(num_bytes != tmp_phdr-&gt;p_filesz){</div>
<div class="line">                                        <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;Reading segment failed\n&quot;</span>);</div>
<div class="line">                                        ret = -1;</div>
<div class="line">                                        <span class="keywordflow">goto</span> out;</div>
<div class="line">                                }</div>
<div class="line">                                leftover_size = (tmp_phdr-&gt;p_memsz - </div>
<div class="line">                                                tmp_phdr-&gt;p_filesz + 1);</div>
<div class="line">                                leftover_data = (<span class="keywordtype">char</span> *)<a class="code" href="sw__buddy_8h.html#a66652368e6d05f18bdc4be02b0c62694">sw_malloc</a>(</div>
<div class="line">                                                tmp_phdr-&gt;p_memsz -</div>
<div class="line">                                                tmp_phdr-&gt;p_filesz+ 1);</div>
<div class="line">                                <a class="code" href="sw__mem__functions_8h.html#a14af1b39b1154a36624740bad34b813f" title="memory set">sw_memset</a>(leftover_data,0x0,(tmp_phdr-&gt;p_memsz -</div>
<div class="line">                                                        tmp_phdr-&gt;p_filesz + 1));</div>
<div class="line">                                <a class="code" href="sw__mem__functions_8h.html#a51ad02aba462d7be9a03231afa56de27" title="This version of memcpy assumes disjoint ptrs src, dst.">sw_memcpy</a>(base_va,leftover_data,leftover_size); </div>
<div class="line">                                <a class="code" href="sw__mem__functions_8h.html#a8bf0e52640edb19377570fd04052d6c1">sw_malloc_free</a>(leftover_data);          </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                        }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                tmp_phdr = ( <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *)((<span class="keywordtype">char</span> *)tmp_phdr + </div>
<div class="line">                                elf_header.<a class="code" href="structElf32__Ehdr.html#afa2289f96d86fcc568a3b1f40cc8953e">e_phentsize</a>);</div>
<div class="line">        }       </div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">/* TODO: </span></div>
<div class="line"><span class="comment">           1) Also, Add support for dynamic linking (Not needed for now )</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">out:</div>
<div class="line">        <span class="comment">/* Free the allocated memory and resources here */</span> </div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(phdr_table){</div>
<div class="line">                tmp_phdr = phdr_table;</div>
<div class="line">                <span class="keywordflow">for</span>(num_of_segments = 0,num_of_loadable_segments = 0;</div>
<div class="line">                                num_of_segments &lt; elf_header.<a class="code" href="structElf32__Ehdr.html#a360898812db1655f8cb8258780d9df5b">e_phnum</a>;</div>
<div class="line">                                num_of_segments++){</div>
<div class="line">                        <span class="keywordflow">if</span>(tmp_phdr-&gt;p_type == <a class="code" href="elf_8h.html#a84d7768fd6c6ece599d297090900cf92">PT_LOAD</a>){</div>
<div class="line">                                <span class="keywordflow">if</span>(!flag[num_of_loadable_segments]){</div>
<div class="line">                                        <a class="code" href="mem__mng_8h.html#a693354d2eff452e5a2c6786a7d965bf9" title="Reserves the required pages in the bitmap.">sw_vir_addr_free</a>(((<a class="code" href="sw__types_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)base_va + </div>
<div class="line">                                                                tmp_phdr-&gt;p_vaddr),</div>
<div class="line">                                                        tmp_phdr-&gt;p_memsz );</div>
<div class="line"></div>
<div class="line">                                }</div>
<div class="line">                                num_of_loadable_segments++;</div>
<div class="line">                        }</div>
<div class="line">                        tmp_phdr = ( <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *)((<span class="keywordtype">char</span> *)tmp_phdr + </div>
<div class="line">                                        elf_header.<a class="code" href="structElf32__Ehdr.html#afa2289f96d86fcc568a3b1f40cc8953e">e_phentsize</a>);</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a class="code" href="sw__mem__functions_8h.html#a8bf0e52640edb19377570fd04052d6c1">sw_malloc_free</a>(phdr_table);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(fp != -1){</div>
<div class="line"></div>
<div class="line">                <a class="code" href="fat32_8c.html#a0ca3db9f9234948f42c95d5bec2820b0" title="Close the opened file based on the file descriptor and free the file structure pointer.">file_close</a>(fp);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ab6814f634bead0f3ecd360e88acd9df8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int elf_loader_cleanup </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>clean up function to remove the mappings </p>
<p>cleans up the reserved secure memory region</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">psa_config</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success , -1 on failure </dd></dl>

<p>Definition at line <a class="el" href="elf__loader_8c_source.html#l00084">84</a> of file <a class="el" href="elf__loader_8c_source.html">elf_loader.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <span class="keywordtype">int</span> status = 0;</div>
<div class="line">        <span class="comment">/* 0 indicates that the mapping is successful, so do the cleanup */</span> </div>
<div class="line">        status = <a class="code" href="page__table_8h.html#a052242469f722badd350a69d03e9e88a" title="Unmap a range of secure memory area.">unmap_secure_memory</a>((<a class="code" href="sw__types_8h.html#a8a8f44dda695920b3f7210c1c28ff23b">va_t</a>)<a class="code" href="sw__board_8h.html#aed82c0b91868582b0328eff0c59f9db8">BASE_LOAD_ADDRESS</a>, </div>
<div class="line">                        <a class="code" href="mem__mng_8h.html#af736426da3c7639cf81900258bdd8a05">SECTION_SIZE</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (status == -1){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;Unable to unmap secure memory of elf loader\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> status;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="acbdca6c083b942acbb03820f4892bf15"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_number_of_loadable_segments </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structElf32__Ehdr.html">Elf32_Ehdr</a> *&#160;</td>
          <td class="paramname"><em>elf_header</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structElf32__Phdr.html">Elf32_Phdr</a> **&#160;</td>
          <td class="paramname"><em>phdr_tab</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets the number of loadable segments, ie segments with type PT_LOAD. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fp</td><td></td></tr>
    <tr><td class="paramname">elf_header</td><td></td></tr>
    <tr><td class="paramname">phdr_tab</td><td>: pointer to the program header table</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>number of loadable segments on success, -1 on failure </dd></dl>

<p>Definition at line <a class="el" href="elf__loader_8c_source.html#l00629">629</a> of file <a class="el" href="elf__loader_8c_source.html">elf_loader.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">        <span class="keywordtype">int</span> ph_num,num_bytes,num_of_segments,num_of_loadable_segments = 0;</div>
<div class="line">        <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *phdr_table, *tmp_phdr;</div>
<div class="line">        ph_num = elf_header-&gt;<a class="code" href="structElf32__Ehdr.html#a360898812db1655f8cb8258780d9df5b">e_phnum</a>;</div>
<div class="line"></div>
<div class="line">        phdr_table = (<a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *)<a class="code" href="sw__buddy_8h.html#a66652368e6d05f18bdc4be02b0c62694">sw_malloc</a>(ph_num * <span class="keyword">sizeof</span>( <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a>));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(phdr_table == <a class="code" href="sw__types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;No memory available\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        num_bytes = 0;</div>
<div class="line">        num_bytes = <a class="code" href="fat32_8c.html#a273aa89ce2f3dc57b21dfbbe3c64267b" title="Function to read the contents of a file.">file_read</a>(fp,(<span class="keywordtype">char</span> *)phdr_table,</div>
<div class="line">                        (ph_num * <span class="keyword">sizeof</span>(<a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a>)));</div>
<div class="line">        <span class="keywordflow">if</span> (num_bytes != (ph_num * <span class="keyword">sizeof</span>( <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a>))){</div>
<div class="line">                <a class="code" href="sw__debug_8h.html#a501cc8c07cf94dc1a6269c0d3ba5a234">sw_printf</a>(<span class="stringliteral">&quot;Reading Programheader table from ELF file failed\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        } </div>
<div class="line">        <span class="comment">/* Get the number of PT_LOAD segments */</span></div>
<div class="line">        tmp_phdr = phdr_table;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span>(num_of_segments = 0;num_of_segments &lt; elf_header-&gt;<a class="code" href="structElf32__Ehdr.html#a360898812db1655f8cb8258780d9df5b">e_phnum</a>;</div>
<div class="line">                        num_of_segments++)      {</div>
<div class="line">                <span class="keywordflow">if</span>(tmp_phdr-&gt;<a class="code" href="structElf32__Phdr.html#a8b1d2942ddb9abcb85db1429b5116923">p_type</a> == <a class="code" href="elf_8h.html#a84d7768fd6c6ece599d297090900cf92">PT_LOAD</a>)</div>
<div class="line">                        num_of_loadable_segments++;</div>
<div class="line">                tmp_phdr = ( <a class="code" href="structElf32__Phdr.html">Elf32_Phdr</a> *)((<span class="keywordtype">char</span> *)tmp_phdr + </div>
<div class="line">                                elf_header-&gt;<a class="code" href="structElf32__Ehdr.html#afa2289f96d86fcc568a3b1f40cc8953e">e_phentsize</a>);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">        *phdr_tab = phdr_table;</div>
<div class="line">        <span class="keywordflow">return</span> num_of_loadable_segments;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jan 3 2013 00:33:52 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
